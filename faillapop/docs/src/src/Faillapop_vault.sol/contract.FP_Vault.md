# FP_Vault
[Git Source](https://github.com/jcr-security/solidity-security-teaching-resources/blob/7024bbd4dfb96e5bd0815e639fbc19b2a524a34b/src/Faillapop_vault.sol)

**Inherits:**
AccessControl

**Author:**
Faillapop team :D

The contract allows anyone to stake and unstake Ether. When a seller publishes a new item
in the shop, the funds are locked during the selling process. Then, If the user is considered malicious,
the funds are slashed.

*Security review is pending... should we deploy this?*


## State Variables
### ADMIN_ROLE
Constants ******************************************************

The admin role ID for the AccessControl contract


```solidity
bytes32 constant ADMIN_ROLE = keccak256("ADMIN_ROLE");
```


### DAO_ROLE
The DAO role ID for the AccessControl contract


```solidity
bytes32 constant DAO_ROLE = keccak256("DAO_ROLE");
```


### SHOP_ROLE
The Shop role ID for the AccessControl contract


```solidity
bytes32 constant SHOP_ROLE = keccak256("SHOP_ROLE");
```


### balance
State vars  ******************************************************

The balance of the users in the vault


```solidity
mapping(address => uint256) public balance;
```


### lockedFunds
The amount of funds locked for selling purposes


```solidity
mapping(address => uint256) public lockedFunds;
```


### nftContract
address of the NFT contract


```solidity
address public nftContract;
```


### shopContract
Shop contract


```solidity
IFP_Shop public shopContract;
```


### daoContract
DAO contract


```solidity
IFP_DAO public daoContract;
```


### max_claimable_amount
Maximum claimable amount


```solidity
uint256 public max_claimable_amount;
```


### rewardsClaimed
The amount of rewards claimed by each user


```solidity
mapping(address => uint256) public rewardsClaimed;
```


### totalSlashed
The total amount of funds slashed


```solidity
uint256 public totalSlashed;
```


## Functions
### enoughStaked

Check if the user has enough staked funds to lock or unstake


```solidity
modifier enoughStaked(address user, uint256 amount);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`user`|`address`|The address of the user to check|
|`amount`|`uint256`|The amount of funds to check|


### constructor

External  ***************************************************************

Constructor, initializes the contract


```solidity
constructor(address token, address shop, address dao);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`token`|`address`|The address of the powerseller NFT contract|
|`shop`|`address`|The address of the Shop contract|
|`dao`|`address`|The address of the DAO contract|


### doStake

Stake attached funds in the vault for later locking, the users must do it on their own


```solidity
function doStake() external payable;
```

### doUnstake

Unstake unlocked funds from the vault, the user must do it on their own


```solidity
function doUnstake(uint256 amount) external enoughStaked(msg.sender, amount);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`amount`|`uint256`|The amount of funds to unstake|


### doLock

Lock funds for selling purposes, the funds are locked until the sale is completed


```solidity
function doLock(address user, uint256 amount) external onlyRole(SHOP_ROLE) enoughStaked(user, amount);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`user`|`address`|The address of the user that is selling|
|`amount`|`uint256`|The amount of funds to lock|


### doUnlock

Unlock funds after the sale is completed


```solidity
function doUnlock(address user, uint256 amount) external onlyRole(SHOP_ROLE);
```

### doSlash

Slash funds if the user is considered malicious by the DAO


```solidity
function doSlash(address badUser) external onlyRole(DAO_ROLE);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`badUser`|`address`|The address of the malicious user to be slashed|


### updateConfig

Modify configuration parameters, only the owner can do it


```solidity
function updateConfig(address newDao, address newShop, address newNft) external onlyRole(ADMIN_ROLE);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`newDao`|`address`|The address of the new DAO contract|
|`newShop`|`address`|The address of the new Shop contract|
|`newNft`|`address`|The address of the new NFT contract|


### claimRewards

Claim rewards generated by slashing malicious users.
First checks if the user is elegible through the checkPrivilege function that will revert if not.


```solidity
function claimRewards() external;
```

### distributeSlashing

Internal ****************************************************************

Sets a new maximum claimable amount per user based on the total slashed amount


```solidity
function distributeSlashing(uint256 amount) internal;
```

### vaultBalance

Views  ******************************************************

Get the balance of the vault


```solidity
function vaultBalance() public view returns (uint256);
```

### userBalance

Get the staked balance of a user


```solidity
function userBalance(address user) public view returns (uint256);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`user`|`address`|The address of the user to query|


### userLockedBalance

Get the locked balance of a user


```solidity
function userLockedBalance(address user) public view returns (uint256);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`user`|`address`|The address of the user to query|


## Events
### Stake
Events and modifiers ****************************************************

Emitted when a user stakes funds, contains the user address and the amount staked


```solidity
event Stake(address user, uint256 amount);
```

### Unstake
Emitted when a user unstakes funds, contains the user address and the amount unstaked


```solidity
event Unstake(address user, uint256 amount);
```

### Locked
Emitted when a user funds get locked, contains the user address and the amount locked


```solidity
event Locked(address user, uint256 amount);
```

### Unlocked
Emitted when a user funds get unlocked, contains the user address and the amount unlocked


```solidity
event Unlocked(address user, uint256 amount);
```

### Slashed
Emitted when a user funds get slashed, contains the user address and the amount slashed


```solidity
event Slashed(address user, uint256 amount);
```

### RewardsClaimed
Emitted when a user claims rewards, contains the user address and the amount claimed


```solidity
event RewardsClaimed(address user, uint256 amount);
```

### NewConfig
Emitted when the contract configuration is changed, contains the address of the Shop, DAO and NFT contracts


```solidity
event NewConfig(address shop, address dao, address nft);
```

